{% extends "base.html" %}
{% block content %}
  <h1 class="mb-3">Registros</h1>

  <form method="get" action="{{ url_for('registros') }}" class="card p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Desde</label>
        <input type="date" name="from" class="form-control" value="{{ d_from if d_from else '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Hasta</label>
        <input type="date" name="to" class="form-control" value="{{ d_to if d_to else '' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Semana</label>
        <select name="semana" class="form-select">
          <option value="">-- (opcional) --</option>
          {% for num, r in week_map.items()|sort %}
            <option value="{{ num }}" {{ 'selected' if semana_sel==num }}>{{ num }} ({{ r[0] }} → {{ r[1] }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Mostrar</label>
        {% set opciones = [
          ('censo','Censo'),
          ('eventos','Eventos de seguridad'),
          ('duplicidades','Duplicidades'),
          ('encuestas','Encuesta de satisfacción'),
          ('atencion','Atención al público'),
          ('robos','Robos y hurtos'),
          ('miscelaneo','Misceláneo'),
          ('desviaciones','Desviaciones'),
          ('solicitud_ot','Solicitud y OT de usuario'),
          ('reclamos','Reclamos de usuarios'),
          ('alarmas','Activación de alarma'),
          ('extensiones','Extensión y excepción'),
          ('onboarding','Registro onboarding'),
          ('apertura','Apertura de habitación'),
          ('cumplimiento','Cumplimiento EECC')
        ] %}
        <select name="vista" class="form-select" onchange="this.form.submit()">
          {% for v, label in opciones %}
            <option value="{{ v }}" {{ 'selected' if vista==v }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-outline-primary w-100" type="submit">Aplicar</button>
      </div>
    </div>
  </form>

  {% macro delbtn(entity, id) -%}
    <form method="post"
          action="{{ url_for('delete_record', entity=entity, rid=id) }}"
          onsubmit="return confirm('¿Eliminar este registro?');"
          style="display:inline;">
      <input type="hidden" name="next" value="{{ request.full_path }}">
      <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
    </form>
  {%- endmacro %}

  {# =================== CENSO =================== #}
  {% if vista == 'censo' %}
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">Censo</h2>
        <div class="toolbar">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_entity', entity='censo', **request.args) }}">Descargar CSV</a>
        </div>
      </div>
      <div class="mt-2 table-responsive">
        <table>
          <thead><tr><th>Acciones</th><th>Fecha</th><th>Censo día</th><th>Censo noche</th><th>Total</th></tr></thead>
          <tbody>
            {% for r in census %}
              <tr>
                <td>{{ delbtn('censo', r.id) }}</td>
                <td>{{ r.fecha }}</td><td>{{ r.censo_dia }}</td><td>{{ r.censo_noche }}</td><td>{{ r.total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# … (secciones intermedias SIN cambios funcionales, igual que tus tablas actuales) … #}

  {# =================== ACTIVACIÓN DE ALARMA =================== #}
  {% if vista == 'alarmas' %}
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">Activación de alarma</h2>
        <div class="toolbar">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_entity', entity='alarmas', **request.args) }}">Descargar CSV</a>
        </div>
      </div>
      <div class="mt-2 table-responsive">
        <table>
          <thead>
            <tr>
              <th>Acciones</th>
              <th>Módulo</th><th>N° Habitación</th><th>Nombre Recepcionista</th><th>Fecha</th><th>Empresa</th>
              <th>ID</th><th>C.O.</th>
              <th>Aviso mantención (h)</th><th>Llegada mantención (h)</th>
              <th>Aviso Líder (h)</th><th>Llegada Líder (h)</th>
              <th>Hora Reporte SALFA</th>
              <th>Tipo Evento</th><th>Tipo Actividad</th><th>Fecha Reporte</th><th>Turno Recepción/Ingresos</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in alarmas %}
              <tr>
                <td>{{ delbtn('alarmas', r.id) }}</td>
                <td>{{ r.modulo or '' }}</td>
                <td>{{ r.n_habitacion or '' }}</td>
                <td>{{ r.nombre_recepcionista or '' }}</td>
                <td>{{ r.fecha }}</td>
                <td>{{ r.empresa or '' }}</td>
                <td>{{ r.id_interno or '' }}</td>
                <td>{{ r.co or '' }}</td>
                <td>{{ r.aviso_mantencion_h if r.aviso_mantencion_h is not none else '' }}</td>
                <td>{{ r.llegada_mantencion_h if r.llegada_mantencion_h is not none else '' }}</td>
                <td>{{ r.aviso_lider_h if r.aviso_lider_h is not none else '' }}</td>
                <td>{{ r.llegada_lider_h if r.llegada_lider_h is not none else '' }}</td>
                <td>{{ r.hora_reporte_salfa.strftime('%H:%M') if r.hora_reporte_salfa else '' }}</td>
                <td>{{ r.tipo_evento or '' }}</td>
                <td>{{ r.tipo_actividad or '' }}</td>
                <td>{{ r.fecha_reporte or '' }}</td>
                <td>{{ r.turno_recepcion_ingresos or '' }}</td>
                <td>{{ r.observaciones or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# =================== EXTENSIÓN / EXCEPCIÓN =================== #}
  {% if vista == 'extensiones' %}
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">Extensión y excepción</h2>
        <div class="toolbar">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_entity', entity='extensiones', **request.args) }}">Descargar CSV</a>
        </div>
      </div>
      <div class="mt-2 table-responsive">
        <table>
          <thead>
            <tr>
              <th>Acciones</th>
              <th>Fecha solicitud</th><th>ID</th><th>Empresa</th><th>CO</th><th>Gerencia</th>
              <th>Proyecto</th><th>Cant. clientes</th><th>Desde</th><th>Hasta</th><th>Aprobador</th><th>Observación</th>
            </tr>
          </thead>
          <tbody>
            {% for r in extensiones %}
              <tr>
                <td>{{ delbtn('extensiones', r.id) }}</td>
                <td>{{ r.fecha_solicitud }}</td>
                <td>{{ r.id_interno or '' }}</td>
                <td>{{ r.empresa or '' }}</td>
                <td>{{ r.co or '' }}</td>
                <td>{{ r.gerencia or '' }}</td>
                <td>{{ r.proyecto or '' }}</td>
                <td>{{ r.cant_clientes if r.cant_clientes is not none else '' }}</td>
                <td>{{ r.desde or '' }}</td>
                <td>{{ r.hasta or '' }}</td>
                <td>{{ r.aprobador or '' }}</td>
                <td>{{ r.observacion or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# =================== ONBOARDING =================== #}
  {% if vista == 'onboarding' %}
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">Registro onboarding</h2>
        <div class="toolbar">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_entity', entity='onboarding', **request.args) }}">Descargar CSV</a>
        </div>
      </div>
      <div class="mt-2 table-responsive">
        <table>
          <thead>
            <tr>
              <th>Acciones</th>
              <th>Fecha/Hora</th><th>Nombre</th><th>RUT</th><th>Empresa</th><th>ID</th><th>Archivo PDF</th>
            </tr>
          </thead>
          <tbody>
            {% for r in onboarding %}
              <tr>
                <td>{{ delbtn('onboarding', r.id) }}</td>
                <td>{{ r.fecha_hora }}</td>
                <td>{{ r.nombre or '' }}</td>
                <td>{{ r.rut or '' }}</td>
                <td>{{ r.empresa or '' }}</td>
                <td>{{ r.id_interno or '' }}</td>
                <td>{{ r.archivo_pdf or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# =================== APERTURA =================== #}
  {% if vista == 'apertura' %}
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">Apertura de habitación</h2>
        <div class="toolbar">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_entity', entity='apertura', **request.args) }}">Descargar CSV</a>
        </div>
      </div>
      <div class="mt-2 table-responsive">
        <table>
          <thead>
            <tr>
              <th>Acciones</th>
              <th>Fecha</th><th>Habitación</th><th>Hora</th><th>Responsable</th><th>Estado de la chapa (motivo)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in apertura %}
              <tr>
                <td>{{ delbtn('apertura', r.id) }}</td>
                <td>{{ r.fecha }}</td>
                <td>{{ r.habitacion or '' }}</td>
                <td>{{ r.hora.strftime('%H:%M') if r.hora else '' }}</td>
                <td>{{ r.responsable or '' }}</td>
                <td>{{ r.estado_chapa or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# =================== CUMPLIMIENTO EECC =================== #}
  {% if vista == 'cumplimiento' %}
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">Cumplimiento EECC</h2>
        <div class="toolbar">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_entity', entity='cumplimiento', **request.args) }}">Descargar CSV</a>
        </div>
      </div>
      <div class="mt-2 table-responsive">
        <table>
          <thead>
            <tr>
              <th>Acciones</th>
              <th>Empresa</th><th>N° Contrato</th><th>C.O.</th><th>Correo</th><th>ID</th><th>Turno</th>
            </tr>
          </thead>
          <tbody>
            {% for r in cumplimiento %}
              <tr>
                <td>{{ delbtn('cumplimiento', r.id) }}</td>
                <td>{{ r.empresa or '' }}</td>
                <td>{{ r.n_contrato or '' }}</td>
                <td>{{ r.co or '' }}</td>
                <td>{{ r.correo_electronico or '' }}</td>
                <td>{{ r.id_interno or '' }}</td>
                <td>{{ r.turno or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

{% endblock %}

