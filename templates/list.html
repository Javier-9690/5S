{% extends "base.html" %}
{% block title %}Sistema de Gestión 5400 - Registros{% endblock %}

{% block content %}
<div class="content-container">
  <h1 class="page-title">Registros del Sistema</h1>

  <!-- Filtros -->
  <div class="filter-card">
    <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h5>
    <form method="get" action="{{ url_for('registros') }}">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Fecha Desde</label>
          <input type="date" name="from" class="form-control" value="{{ d_from if d_from else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha Hasta</label>
          <input type="date" name="to" class="form-control" value="{{ d_to if d_to else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Semana Específica</label>
          <select name="semana" class="form-select">
            <option value="">-- Todas las semanas --</option>
            {% for num, r in week_map.items()|sort %}
              <option value="{{ num }}" {{ 'selected' if semana_sel==num }}>{{ num }} ({{ r[0] }} → {{ r[1] }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Módulo</label>
          {% set opciones = [
            ('censo','Censo'),
            ('eventos','Eventos de seguridad'),
            ('duplicidades','Duplicidades'),
            ('encuestas','Encuesta de satisfacción'),
            ('atencion','Atención al público'),
            ('robos','Robos y hurtos'),
            ('miscelaneo','Misceláneo'),
            ('desviaciones','Desviaciones'),
            ('solicitud_ot','Solicitud y OT de usuario'),
            ('reclamos','Reclamos de usuarios'),
            ('alarmas', 'Activación de alarma'),
            ('extensiones', 'Extensión y excepción'),
            ('onboarding', 'Registro onboarding'),
            ('apertura', 'Apertura de habitación'),
            ('cumplimiento', 'Cumplimiento EECC')
          ] %}
          <select name="vista" class="form-select" onchange="this.form.submit()">
            {% for v, label in opciones %}
              <option value="{{ v }}" {{ 'selected' if vista==v }}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12">
          <button class="btn btn-primary-custom" type="submit">
            <i class="fas fa-search me-1"></i> Aplicar Filtros
          </button>
          <a href="{{ url_for('registros') }}" class="btn btn-outline-secondary">
            <i class="fas fa-undo me-1"></i> Limpiar Filtros
          </a>
        </div>
      </div>
    </form>
  </div>

  {# Macro botón eliminar #}
  {% macro delbtn(entity, id) -%}
    <form method="post"
          action="{{ url_for('delete_record', entity=entity, rid=id) }}"
          onsubmit="return confirm('¿Está seguro de que desea eliminar este registro?');"
          style="display:inline;">
      <input type="hidden" name="next" value="{{ request.full_path }}">
      <button class="btn btn-sm btn-outline-danger" type="submit" title="Eliminar registro">
        <i class="fas fa-trash"></i>
      </button>
    </form>
  {%- endmacro %}

  <!-- Sección de datos -->
  <div class="mt-4">
    <!-- CENSO -->
    {% if vista == 'censo' %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-users me-2"></i>Registros de Censo</h4>
        <a class="btn btn-primary-custom" href="{{ url_for('download_entity', entity='censo', **request.args) }}">
          <i class="fas fa-download me-1"></i> Descargar CSV
        </a>
      </div>
      
      {% if census %}
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>Fecha</th>
                <th>Censo Día</th>
                <th>Censo Noche</th>
                <th>Total</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody>
              {% for r in census %}
                <tr>
                  <td class="table-actions">
                    {{ delbtn('censo', r.id) }}
                  </td>
                  <td>{{ r.fecha }}</td>
                  <td>{{ r.censo_dia }}</td>
                  <td>{{ r.censo_noche }}</td>
                  <td><strong>{{ r.total }}</strong></td>
                  <td><small class="text-muted">{{ r.creado.strftime('%d/%m/%Y %H:%M') }}</small></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-4">
          <i class="fas fa-users fa-2x mb-3"></i>
          <h5>No se encontraron registros de censo</h5>
          <p class="mb-0">No hay datos de censo para los filtros seleccionados.</p>
        </div>
      {% endif %}
    {% endif %}

    <!-- EVENTOS DE SEGURIDAD -->
    {% if vista == 'eventos' %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-shield-alt me-2"></i>Eventos de Seguridad</h4>
        <a class="btn btn-primary-custom" href="{{ url_for('download_entity', entity='eventos', **request.args) }}">
          <i class="fas fa-download me-1"></i> Descargar CSV
        </a>
      </div>
      
      {% if eventos %}
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>Fecha</th>
                <th>Horario</th>
                <th>Qué Ocurrió</th>
                <th>Nombre Afectado</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody>
              {% for r in eventos %}
                <tr>
                  <td class="table-actions">
                    {{ delbtn('eventos', r.id) }}
                  </td>
                  <td>{{ r.fecha }}</td>
                  <td>{{ r.horario }}</td>
                  <td>
                    <span title="{{ r.que_ocurrio }}">
                      {{ r.que_ocurrio[:50] }}{% if r.que_ocurrio|length > 50 %}...{% endif %}
                    </span>
                  </td>
                  <td>{{ r.nombre_afectado or '-' }}</td>
                  <td><small class="text-muted">{{ r.creado.strftime('%d/%m/%Y %H:%M') }}</small></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-4">
          <i class="fas fa-shield-alt fa-2x mb-3"></i>
          <h5>No se encontraron eventos de seguridad</h5>
          <p class="mb-0">No hay eventos de seguridad para los filtros seleccionados.</p>
        </div>
      {% endif %}
    {% endif %}

    <!-- DUPLICIDADES -->
    {% if vista == 'duplicidades' %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-copy me-2"></i>Duplicidades</h4>
        <a class="btn btn-primary-custom" href="{{ url_for('download_entity', entity='duplicidades', **request.args) }}">
          <i class="fas fa-download me-1"></i> Descargar CSV
        </a>
      </div>
      
      {% if duplics %}
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>Semana</th>
                <th>Fecha</th>
                <th>ID</th>
                <th>Empresa</th>
                <th>Descripción</th>
                <th>Estatus</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody>
              {% for r in duplics %}
                <tr>
                  <td class="table-actions">
                    {{ delbtn('duplicidades', r.id) }}
                  </td>
                  <td>{{ r.semana }}</td>
                  <td>{{ r.fecha }}</td>
                  <td>{{ r.id_interno or '-' }}</td>
                  <td>
                    <span title="{{ r.empresa_contratista or '' }}">
                      {{ (r.empresa_contratista or '-')[:20] }}{% if (r.empresa_contratista or '')|length > 20 %}...{% endif %}
                    </span>
                  </td>
                  <td>
                    <span title="{{ r.descripcion_problema or '' }}">
                      {{ (r.descripcion_problema or '')[:30] }}{% if (r.descripcion_problema or '')|length > 30 %}...{% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="badge {% if r.estatus == 'Cerrado' %}bg-success{% else %}bg-warning{% endif %}">
                      {{ r.estatus or 'Abierto' }}
                    </span>
                  </td>
                  <td><small class="text-muted">{{ r.creado.strftime('%d/%m/%Y %H:%M') }}</small></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-4">
          <i class="fas fa-copy fa-2x mb-3"></i>
          <h5>No se encontraron duplicidades</h5>
          <p class="mb-0">No hay duplicidades para los filtros seleccionados.</p>
        </div>
      {% endif %}
    {% endif %}

    <!-- ENCUESTAS -->
    {% if vista == 'encuestas' %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-poll me-2"></i>Encuestas de Satisfacción</h4>
        <a class="btn btn-primary-custom" href="{{ url_for('download_entity', entity='encuestas', **request.args) }}">
          <i class="fas fa-download me-1"></i> Descargar CSV
        </a>
      </div>
      
      {% if encuestas %}
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>Fecha Hora</th>
                <th>Puntaje 1</th>
                <th>Puntaje 2</th>
                <th>Puntaje 3</th>
                <th>Puntaje 4</th>
                <th>Puntaje 5</th>
                <th>Total</th>
                <th>Promedio</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody>
              {% for r in encuestas %}
                <tr>
                  <td class="table-actions">
                    {{ delbtn('encuestas', r.id) }}
                  </td>
                  <td>{{ r.fecha_hora.strftime('%d/%m/%Y %H:%M') }}</td>
                  <td>{{ r.q1_puntaje if r.q1_puntaje is not none else '-' }}</td>
                  <td>{{ r.q2_puntaje if r.q2_puntaje is not none else '-' }}</td>
                  <td>{{ r.q3_puntaje if r.q3_puntaje is not none else '-' }}</td>
                  <td>{{ r.q4_puntaje if r.q4_puntaje is not none else '-' }}</td>
                  <td>{{ r.q5_puntaje if r.q5_puntaje is not none else '-' }}</td>
                  <td><strong>{{ r.total if r.total is not none else '-' }}</strong></td>
                  <td>
                    <span class="badge {% if r.promedio and r.promedio >= 8 %}bg-success{% elif r.promedio and r.promedio >= 6 %}bg-warning{% else %}bg-danger{% endif %}">
                      {{ "%.2f"|format(r.promedio) if r.promedio is not none else '-' }}
                    </span>
                  </td>
                  <td><small class="text-muted">{{ r.creado.strftime('%d/%m/%Y %H:%M') }}</small></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-4">
          <i class="fas fa-poll fa-2x mb-3"></i>
          <h5>No se encontraron encuestas</h5>
          <p class="mb-0">No hay encuestas para los filtros seleccionados.</p>
        </div>
      {% endif %}
    {% endif %}

    <!-- ATENCIÓN AL PÚBLICO -->
    {% if vista == 'atencion' %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-headset me-2"></i>Atención al Público</h4>
        <a class="btn btn-primary-custom" href="{{ url_for('download_entity', entity='atencion', **request.args) }}">
          <i class="fas fa-download me-1"></i> Descargar CSV
        </a>
      </div>
      
      {% if atenciones %}
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>Fecha</th>
                <th>Tiempo Promedio</th>
                <th>Cantidad</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody>
              {% for r in atenciones %}
                <tr>
                  <td class="table-actions">
                    {{ delbtn('atencion', r.id) }}
                  </td>
                  <td>{{ r.fecha }}</td>
                  <td>{{ '%02d:%02d'|format((r.tiempo_promedio_sec//60),(r.tiempo_promedio_sec%60)) }}</td>
                  <td><strong>{{ r.cantidad }}</strong></td>
                  <td><small class="text-muted">{{ r.creado.strftime('%d/%m/%Y %H:%M') }}</small></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-4">
          <i class="fas fa-headset fa-2x mb-3"></i>
          <h5>No se encontraron registros de atención</h5>
          <p class="mb-0">No hay registros de atención al público para los filtros seleccionados.</p>
        </div>
      {% endif %}
    {% endif %}

    <!-- MÓDULOS RESTANTES -->
    {% if vista not in ['censo', 'eventos', 'duplicidades', 'encuestas', 'atencion'] %}
      {% set entity_data = {
        'robos': (robos, 'Robos y Hurtos', 'fa-exclamation-triangle'),
        'miscelaneo': (miscelaneo, 'Misceláneo', 'fa-tools'),
        'desviaciones': (desviaciones, 'Desviaciones', 'fa-random'),
        'solicitud_ot': (solicitudes_ot, 'Solicitudes OT', 'fa-clipboard-list'),
        'reclamos': (reclamos, 'Reclamos', 'fa-comments'),
        'alarmas': (alarmas, 'Activación de Alarmas', 'fa-bell'),
        'extensiones': (extensiones, 'Extensiones', 'fa-calendar-plus'),
        'onboarding': (onboarding, 'Onboarding', 'fa-user-plus'),
        'apertura': (apertura, 'Apertura de Habitaciones', 'fa-door-open'),
        'cumplimiento': (cumplimiento, 'Cumplimiento EECC', 'fa-check-circle')
      } %}
      
      {% set data, title, icon = entity_data.get(vista, ([], vista|replace('_', ' ')|title, 'fa-database')) %}
      
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas {{ icon }} me-2"></i>{{ title }}</h4>
        <a class="btn btn-primary-custom" href="{{ url_for('download_entity', entity=vista, **request.args) }}">
          <i class="fas fa-download me-1"></i> Descargar CSV
        </a>
      </div>
      
      {% if data %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          Mostrando {{ data|length }} registros de {{ title }}
        </div>
        
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>ID</th>
                <th>Fecha</th>
                <th>Detalles</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody>
              {% for r in data %}
                <tr>
                  <td class="table-actions">
                    {{ delbtn(vista, r.id) }}
                  </td>
                  <td>{{ r.id }}</td>
                  <td>
                    {% if r.fecha %}
                      {{ r.fecha }}
                    {% elif r.fecha_hora %}
                      {{ r.fecha_hora.strftime('%d/%m/%Y %H:%M') }}
                    {% elif r.fecha_solicitud %}
                      {{ r.fecha_solicitud }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if r.descripcion_problema %}
                      <span title="{{ r.descripcion_problema }}">
                        {{ (r.descripcion_problema or '')[:80] }}{% if (r.descripcion_problema or '')|length > 80 %}...{% endif %}
                      </span>
                    {% elif r.nombre %}
                      {{ r.nombre }}
                    {% elif r.empresa %}
                      {{ r.empresa }}
                    {% else %}
                      <span class="text-muted">Ver detalles</span>
                    {% endif %}
                  </td>
                  <td><small class="text-muted">{{ r.creado.strftime('%d/%m/%Y %H:%M') }}</small></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-4">
          <i class="fas {{ icon }} fa-2x mb-3"></i>
          <h5>No se encontraron registros</h5>
          <p class="mb-0">No hay registros de {{ title|lower }} para los filtros seleccionados.</p>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}


