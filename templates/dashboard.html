{% extends "base.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <div class="toolbar">
    <a class="btn" href="{{ url_for('form_semana') }}">Ingresar nuevo registro</a>
    <a class="btn" href="{{ url_for('listar') }}">Registros</a>
  </div>

  {% if not have_data %}
    <p class="muted" style="margin-top:12px;">Aún no hay datos.</p>
  {% else %}
    <!-- Tarjetas -->
    <div class="grid" style="grid-template-columns: repeat(5, minmax(160px,1fr)); margin-top:12px;">
      <div class="card"><strong>Censo total</strong><div>{{ cards.censo_total }}</div></div>
      <div class="card"><strong>Eventos de seguridad</strong><div>{{ cards.eventos_total }}</div></div>
      <div class="card"><strong>Duplicidad</strong><div>{{ cards.duplicidad_total }}</div></div>
      <div class="card"><strong>Encuestas</strong><div>{{ cards.encuesta_total }}</div></div>
      <div class="card"><strong>Tiempo prom. global</strong><div>{{ cards.tiempo_prom_global }}</div></div>
    </div>

    <style>
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; }
      canvas { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px; }
      .notice { padding:10px; background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a; border-radius:10px; }
      .hidden { display:none; }
    </style>

    <!-- Gráficos por día -->
    <div id="charts" style="display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;">
      <div class="notice hidden" id="no-data-msg">No hay datos suficientes para graficar.</div>
      <canvas id="chartCenso" height="120"></canvas>
      <canvas id="chartEventos" height="120"></canvas>
      <canvas id="chartDuplicidad" height="120"></canvas>
      <canvas id="chartEncuesta" height="120"></canvas>
      <canvas id="chartTiempo" height="120"></canvas>
    </div>

    <h2 style="margin-top:16px;">Resumen por semana</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Semana</th>
            <th>Rango</th>
            <th>Censo</th>
            <th>Eventos de seguridad</th>
            <th>Duplicidad</th>
            <th>Encuesta</th>
            <th>Tiempo prom.</th>
            <th>Duplicidad/100 censo</th>
          </tr>
        </thead>
        <tbody>
          {% for r in table %}
            <tr>
              <td>{{ r['semana'] }}</td>
              <td>{{ r['rango'][0] }} → {{ r['rango'][1] }}</td>
              <td>{{ r['censo'] }}</td>
              <td>{{ r['eventos'] }}</td>
              <td>{{ r['duplicidad'] }}</td>
              <td>{{ r['encuesta'] }}</td>
              <td>{{ r['t_prom'] }}</td>
              <td>{{ r['dup_x100'] }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Carga resiliente de Chart.js: primer CDN + fallback -->
    <script>
      (function loadChartJS(){
        function add(src, onload){
          var s = document.createElement('script');
          s.src = src;
          s.defer = true;
          s.onload = onload;
          s.onerror = function(){
            console.warn('Fallo cargando:', src);
          };
          document.head.appendChild(s);
        }
        // Primero jsDelivr; si no, unpkg
        add('https://cdn.jsdelivr.net/npm/chart.js', function(){
          window.__chartJsLoaded = true;
        });
        add('https://unpkg.com/chart.js@4.4.6/dist/chart.umd.js', function(){
          window.__chartJsLoaded = true;
        });
      })();
    </script>

    <script>
      (function(){
        // Datos desde backend (protegidos)
        const series = {{ series|tojson }};
        const labelsIn = Array.isArray(series?.labels_days) ? series.labels_days : [];
        const toNums = arr => (Array.isArray(arr) ? arr : []).map(v => {
          const n = Number(v);
          return Number.isFinite(n) ? n : 0;
        });

        const dataSets = {
          censo:       toNums(series?.censo),
          eventos:     toNums(series?.eventos),
          duplicidad:  toNums(series?.duplicidad),
          encuesta:    toNums(series?.encuesta),
          tavgSec:     toNums(series?.tavg_sec)
        };

        // Normaliza labels: solo strings
        const labels = labelsIn.map(x => (x==null ? '' : String(x)));

        // Debug útil en consola
        console.log('[Dashboard] labels:', labels.length, labels.slice(0,5));
        console.log('[Dashboard] censo:', dataSets.censo.length);
        console.log('[Dashboard] eventos:', dataSets.eventos.length);
        console.log('[Dashboard] duplicidad:', dataSets.duplicidad.length);
        console.log('[Dashboard] encuesta:', dataSets.encuesta.length);
        console.log('[Dashboard] tavgSec:', dataSets.tavgSec.length);

        // Mostrar/ocultar aviso
        const noDataMsg = document.getElementById('no-data-msg');
        function showNoData(msg){
          if (!noDataMsg) return;
          noDataMsg.textContent = msg || 'No hay datos suficientes para graficar. Agrega registros en "Ingresar nuevo registro".';
          noDataMsg.classList.remove('hidden');
        }

        // Espera a que Chart.js esté disponible (por si el primer CDN falla y entra el fallback)
        function whenChartReady(cb, tries=40){
          if (typeof window.Chart !== 'undefined') return cb();
          if (tries <= 0) { showNoData('No se pudo cargar Chart.js desde CDN.'); return; }
          setTimeout(() => whenChartReady(cb, tries-1), 150);
        }

        function makeLine(canvasId, label, arr, transform){
          const el = document.getElementById(canvasId);
          if (!el) return false;
          // Validación mínima: misma longitud y algo de dato >0 (o al menos algún número)
          const data = (transform ? arr.map(transform) : arr);
          const okLabels = labels.length > 0;
          const okData = Array.isArray(data) && data.length === labels.length && data.some(v => Number.isFinite(Number(v)));
          if (!okLabels || !okData) {
            console.info(`Sin datos para ${label} (labels:${labels.length}, data:${data.length})`);
            el.classList.add('hidden');
            return false;
          }
          try{
            const ctx = el.getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels,
                datasets: [{
                  label,
                  data,
                  tension: .25,
                  pointRadius: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                  x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true }},
                  y: { beginAtZero: true }
                }
              }
            });
            return true;
          } catch(e){
            console.error('Error creando gráfico', label, e);
            el.classList.add('hidden');
            return false;
          }
        }

        whenChartReady(function(){
          let drawn = 0;
          drawn += makeLine('chartCenso', 'Censo por día', dataSets.censo);
          drawn += makeLine('chartEventos', 'Eventos de seguridad por día', dataSets.eventos);
          drawn += makeLine('chartDuplicidad', 'Duplicidad por día', dataSets.duplicidad);
          drawn += makeLine('chartEncuesta', 'Encuesta por día', dataSets.encuesta);
          drawn += makeLine('chartTiempo', 'Tiempo promedio por día (min)', dataSets.tavgSec, s => Number((s/60).toFixed(2)));

          if (!drawn) {
            showNoData();
          }
        });
      })();
    </script>
  {% endif %}

  <noscript>
    <div class="notice" style="margin-top:12px;">
      Activa JavaScript para ver los gráficos del dashboard.
    </div>
  </noscript>
{% endblock %}

