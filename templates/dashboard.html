{% extends "base.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <div class="toolbar">
    <a class="btn" href="{{ url_for('form_semana') }}">Capturar</a>
    <a class="btn" href="{{ url_for('listar') }}">Registros</a>
  </div>

  {% if not have_data %}
    <p class="muted" style="margin-top:12px;">Aún no hay datos.</p>
  {% else %}
    <!-- Tarjetas -->
    <div class="grid" style="grid-template-columns: repeat(5, minmax(160px,1fr)); margin-top:12px;">
      <div class="card"><strong>Censo total</strong><div>{{ cards.censo_total }}</div></div>
      <div class="card"><strong>Eventos de seguridad</strong><div>{{ cards.eventos_total }}</div></div>
      <div class="card"><strong>Duplicidad</strong><div>{{ cards.duplicidad_total }}</div></div>
      <div class="card"><strong>Encuestas</strong><div>{{ cards.encuesta_total }}</div></div>
      <div class="card"><strong>Tiempo prom. global</strong><div>{{ cards.tiempo_prom_global }}</div></div>
    </div>

    <style>
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; }
      canvas { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px; }
    </style>

    <!-- Resumen gráfico por tópico -->
    <div style="display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;">
      <canvas id="chartCenso" height="110"></canvas>
      <canvas id="chartEventos" height="110"></canvas>
      <canvas id="chartDuplicidad" height="110"></canvas>
      <canvas id="chartEncuesta" height="110"></canvas>
      <canvas id="chartTiempo" height="110"></canvas>
    </div>

    <h2 style="margin-top:16px;">Resumen por semana</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Semana</th>
            <th>Rango</th>
            <th>Censo</th>
            <th>Eventos de seguridad</th>
            <th>Duplicidad</th>
            <th>Encuesta</th>
            <th>Tiempo prom.</th>
            <th>Duplicidad/100 censo</th>
          </tr>
        </thead>
        <tbody>
          {% for r in table %}
            <tr>
              <td>{{ r['semana'] }}</td>
              <td>{{ r['rango'][0] }} → {{ r['rango'][1] }}</td>
              <td>{{ r['censo'] }}</td>
              <td>{{ r['eventos'] }}</td>
              <td>{{ r['duplicidad'] }}</td>
              <td>{{ r['encuesta'] }}</td>
              <td>{{ r['t_prom'] }}</td>
              <td>{{ r['dup_x100'] }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const labels = {{ labels|tojson }};
      const serie = {{ series|tojson }};

      function makeLine(canvasId, label, data, toFixed=0) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const values = Array.isArray(data) ? data : [];
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label, data: values.map(v => toFixed ? +(+v).toFixed(toFixed) : v) }] },
          options: { responsive:true, plugins:{ legend:{ position:'bottom'} }, scales:{ y:{ beginAtZero:true } } }
        });
      }

      makeLine('chartCenso', 'Censo', serie.censo);
      makeLine('chartEventos', 'Eventos de seguridad', serie.eventos);
      makeLine('chartDuplicidad', 'Duplicidad', serie.duplicidad);
      makeLine('chartEncuesta', 'Encuesta', serie.encuesta);

      // tiempo promedio en minutos con 2 decimales
      const tavgMin = (serie.tavg_sec || []).map(s => (s/60).toFixed(2));
      makeLine('chartTiempo', 'Tiempo promedio (min)', tavgMin, 2);
    </script>
  {% endif %}
{% endblock %}

