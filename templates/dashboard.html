{% extends "base.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <div class="toolbar">
    <a class="btn" href="{{ url_for('form_semana') }}">Ingresar nuevo registro</a>
    <a class="btn" href="{{ url_for('listar') }}">Registros</a>
  </div>

  {% if not have_data %}
    <p class="muted" style="margin-top:12px;">Aún no hay datos.</p>
  {% else %}
    <!-- Tarjetas -->
    <div class="grid" style="grid-template-columns: repeat(5, minmax(160px,1fr)); margin-top:12px;">
      <div class="card"><strong>Censo total</strong><div>{{ cards.censo_total }}</div></div>
      <div class="card"><strong>Eventos de seguridad</strong><div>{{ cards.eventos_total }}</div></div>
      <div class="card"><strong>Duplicidad</strong><div>{{ cards.duplicidad_total }}</div></div>
      <div class="card"><strong>Encuestas</strong><div>{{ cards.encuesta_total }}</div></div>
      <div class="card"><strong>Tiempo prom. global</strong><div>{{ cards.tiempo_prom_global }}</div></div>
    </div>

    <style>
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; }
      canvas { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px; }
      @media (max-width: 720px){
        .card div{font-size:14px}
      }
    </style>

    <!-- Gráficos por día -->
    <div style="display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;">
      <canvas id="chartCenso" height="120"></canvas>
      <canvas id="chartEventos" height="120"></canvas>
      <canvas id="chartDuplicidad" height="120"></canvas>
      <canvas id="chartEncuesta" height="120"></canvas>
      <canvas id="chartTiempo" height="120"></canvas>
    </div>

    <h2 style="margin-top:16px;">Resumen por semana</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Semana</th>
            <th>Rango</th>
            <th>Censo</th>
            <th>Eventos de seguridad</th>
            <th>Duplicidad</th>
            <th>Encuesta</th>
            <th>Tiempo prom.</th>
            <th>Duplicidad/100 censo</th>
          </tr>
        </thead>
        <tbody>
          {% for r in table %}
            <tr>
              <td>{{ r['semana'] }}</td>
              <td>{{ r['rango'][0] }} → {{ r['rango'][1] }}</td>
              <td>{{ r['censo'] }}</td>
              <td>{{ r['eventos'] }}</td>
              <td>{{ r['duplicidad'] }}</td>
              <td>{{ r['encuesta'] }}</td>
              <td>{{ r['t_prom'] }}</td>
              <td>{{ r['dup_x100'] }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const labels = {{ series.labels_days|tojson }};
      const censo = {{ series.censo|tojson }};
      const eventos = {{ series.eventos|tojson }};
      const duplicidad = {{ series.duplicidad|tojson }};
      const encuesta = {{ series.encuesta|tojson }};
      const tavgSec = {{ series.tavg_sec|tojson }};
      const tavgMin = tavgSec.map(s => (s/60).toFixed(2));

      function lineConfig(lbl, data){
        return {
          type: 'line',
          data: { labels, datasets: [{ label: lbl, data, tension:.25, pointRadius:2 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true }}, y: { beginAtZero: true } }
          }
        };
      }

      new Chart(document.getElementById('chartCenso'), lineConfig('Censo por día', censo));
      new Chart(document.getElementById('chartEventos'), lineConfig('Eventos de seguridad por día', eventos));
      new Chart(document.getElementById('chartDuplicidad'), lineConfig('Duplicidad por día', duplicidad));
      new Chart(document.getElementById('chartEncuesta'), lineConfig('Encuesta por día', encuesta));
      new Chart(document.getElementById('chartTiempo'), lineConfig('Tiempo promedio por día (min)', tavgMin));
    </script>
  {% endif %}
{% endblock %}

