{% extends "base.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <div class="toolbar">
    <a class="btn" href="{{ url_for('form_semana') }}">Ingresar nuevo registro</a>
    <a class="btn" href="{{ url_for('listar') }}">Registros</a>
  </div>

  {% if not have_data %}
    <p class="muted" style="margin-top:12px;">Aún no hay datos.</p>
  {% else %}
    <!-- Tarjetas -->
    <div class="grid" style="grid-template-columns: repeat(5, minmax(160px,1fr)); margin-top:12px;">
      <div class="card"><strong>Censo total</strong><div>{{ cards.censo_total }}</div></div>
      <div class="card"><strong>Eventos de seguridad</strong><div>{{ cards.eventos_total }}</div></div>
      <div class="card"><strong>Duplicidad</strong><div>{{ cards.duplicidad_total }}</div></div>
      <div class="card"><strong>Encuestas</strong><div>{{ cards.encuesta_total }}</div></div>
      <div class="card"><strong>Tiempo prom. global</strong><div>{{ cards.tiempo_prom_global }}</div></div>
    </div>

    <style>
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; }
      canvas { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px; }
      .notice { padding:10px; background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a; border-radius:10px; }
    </style>

    <!-- Gráficos por día -->
    <div id="charts" style="display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;">
      <div class="notice" id="no-data-msg" style="display:none;">No hay datos suficientes para graficar.</div>
      <canvas id="chartCenso" height="120"></canvas>
      <canvas id="chartEventos" height="120"></canvas>
      <canvas id="chartDuplicidad" height="120"></canvas>
      <canvas id="chartEncuesta" height="120"></canvas>
      <canvas id="chartTiempo" height="120"></canvas>
    </div>

    <h2 style="margin-top:16px;">Resumen por semana</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Semana</th>
            <th>Rango</th>
            <th>Censo</th>
            <th>Eventos de seguridad</th>
            <th>Duplicidad</th>
            <th>Encuesta</th>
            <th>Tiempo prom.</th>
            <th>Duplicidad/100 censo</th>
          </tr>
        </thead>
        <tbody>
          {% for r in table %}
            <tr>
              <td>{{ r['semana'] }}</td>
              <td>{{ r['rango'][0] }} → {{ r['rango'][1] }}</td>
              <td>{{ r['censo'] }}</td>
              <td>{{ r['eventos'] }}</td>
              <td>{{ r['duplicidad'] }}</td>
              <td>{{ r['encuesta'] }}</td>
              <td>{{ r['t_prom'] }}</td>
              <td>{{ r['dup_x100'] }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function(){
        // 1) Datos desde el backend con defensas
        const series = {{ series|tojson }};
        const labels = Array.isArray(series?.labels_days) ? series.labels_days : [];
        const censo = Array.isArray(series?.censo) ? series.censo : [];
        const eventos = Array.isArray(series?.eventos) ? series.eventos : [];
        const duplicidad = Array.isArray(series?.duplicidad) ? series.duplicidad : [];
        const encuesta = Array.isArray(series?.encuesta) ? series.encuesta : [];
        const tavgSec = Array.isArray(series?.tavg_sec) ? series.tavg_sec : [];

        // 2) Chequeos previos: si algo falla, no rompemos toda la página
        const noDataMsg = document.getElementById('no-data-msg');
        function hasGoodData(arr){ return Array.isArray(arr) && arr.length > 0 && arr.every(v => typeof v === 'number'); }
        const okLabels = Array.isArray(labels) && labels.length > 0;

        // 3) Si Chart no está (CDN caído), avisamos y salimos
        if (typeof window.Chart === 'undefined') {
          console.warn('Chart.js no cargó (CDN). Revisa conectividad o política de contenido CSP.');
          if (noDataMsg) {
            noDataMsg.style.display = 'block';
            noDataMsg.textContent = 'No se pudo cargar Chart.js desde CDN. Los gráficos no se mostrarán.';
          }
          return;
        }

        // 4) Función segura para crear líneas
        function makeLine(canvasId, label, data, transformFn) {
          try {
            const el = document.getElementById(canvasId);
            if (!el) return;
            if (!okLabels || !hasGoodData(data)) {
              console.info(`Sin datos para ${label}`);
              el.style.display = 'none';
              return;
            }
            const seriesData = transformFn ? data.map(transformFn) : data;
            const ctx = el.getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels,
                datasets: [{
                  label,
                  data: seriesData,
                  tension: .25,
                  pointRadius: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                  x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true }},
                  y: { beginAtZero: true }
                }
              }
            });
          } catch (e) {
            console.error(`Error creando gráfico ${label}:`, e);
            const el = document.getElementById(canvasId);
            if (el) el.style.display = 'none';
          }
        }

        // 5) Mostrar aviso si no hay nada graficable
        const graficables =
          (okLabels && (hasGoodData(censo) || hasGoodData(eventos) || hasGoodData(duplicidad) || hasGoodData(encuesta) || hasGoodData(tavgSec)));
        if (!graficables && noDataMsg) {
          noDataMsg.style.display = 'block';
          noDataMsg.textContent = 'No hay datos suficientes para graficar. Agrega registros en "Ingresar nuevo registro".';
        }

        // 6) Gráficos (tiempo en minutos con 2 decimales)
        makeLine('chartCenso', 'Censo por día', censo);
        makeLine('chartEventos', 'Eventos de seguridad por día', eventos);
        makeLine('chartDuplicidad', 'Duplicidad por día', duplicidad);
        makeLine('chartEncuesta', 'Encuesta por día', encuesta);
        makeLine('chartTiempo', 'Tiempo promedio por día (min)', tavgSec, s => Number((s/60).toFixed(2)));
      })();
    </script>
  {% endif %}
{% endblock %}


