{% extends "base.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <div class="toolbar">
    <a class="btn" href="{{ url_for('form_semana') }}">Ingresar nuevo registro</a>
    <a class="btn" href="{{ url_for('listar') }}">Registros</a>
  </div>

  {% if not have_data %}
    <p class="muted" style="margin-top:12px;">Aún no hay datos.</p>
  {% else %}
    <!-- Tarjetas -->
    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin-top:12px;">
      <div class="card"><strong>Censo total</strong><div>{{ cards.censo_total }}</div></div>
      <div class="card"><strong>Eventos de seguridad</strong><div>{{ cards.eventos_total }}</div></div>
      <div class="card"><strong>Duplicidad</strong><div>{{ cards.duplicidad_total }}</div></div>
      <div class="card"><strong>Encuestas</strong><div>{{ cards.encuesta_total }}</div></div>
      <div class="card"><strong>Tiempo prom. global</strong><div>{{ cards.tiempo_prom_global }}</div></div>
    </div>

    <style>
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; }
      /* contenedor alto y ancho completo para cada gráfico */
      .chart-box{width:100%; height:380px; margin:18px 0 6px;}
      .panel{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;}
    </style>

    <!-- Gráficos por día: UNO POR FILA, GRANDE -->
    <div class="panel">
      <div class="chart-box"><canvas id="chartCenso"></canvas></div>
      <div class="chart-box"><canvas id="chartEventos"></canvas></div>
      <div class="chart-box"><canvas id="chartDuplicidad"></canvas></div>
      <div class="chart-box"><canvas id="chartEncuesta"></canvas></div>
      <div class="chart-box"><canvas id="chartTiempo"></canvas></div>
    </div>

    <h2 style="margin-top:18px;">Resumen por semana</h2>
    <div class="panel">
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Semana</th>
              <th>Rango</th>
              <th>Censo</th>
              <th>Eventos de seguridad</th>
              <th>Duplicidad</th>
              <th>Encuesta</th>
              <th>Tiempo prom.</th>
              <th>Duplicidad/100 censo</th>
            </tr>
          </thead>
          <tbody>
            {% for r in table %}
              <tr>
                <td>{{ r['semana'] }}</td>
                <td>{{ r['rango'][0] }} → {{ r['rango'][1] }}</td>
                <td>{{ r['censo'] }}</td>
                <td>{{ r['eventos'] }}</td>
                <td>{{ r['duplicidad'] }}</td>
                <td>{{ r['encuesta'] }}</td>
                <td>{{ r['t_prom'] }}</td>
                <td>{{ r['dup_x100'] }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Datos por día desde el backend
      const labels = {{ series.labels_days|tojson }};
      const censo = {{ series.censo|tojson }};
      const eventos = {{ series.eventos|tojson }};
      const duplicidad = {{ series.duplicidad|tojson }};
      const encuesta = {{ series.encuesta|tojson }};
      const tavgSec = {{ series.tavg_sec|tojson }};
      const tavgMin = tavgSec.map(s => (s / 60).toFixed(2));

      // Config general: ocupa el padre (.chart-box) de 380px de alto y 100% ancho
      function lineConfig(lbl, data){
        return {
          type: 'line',
          data: { labels, datasets: [{ label: lbl, data, tension: 0.25, pointRadius: 2 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,  // usa el alto del contenedor .chart-box
            plugins: { legend: { position: 'bottom' } },
            scales: {
              x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true }},
              y: { beginAtZero: true }
            }
          }
        };
      }

      new Chart(document.getElementById('chartCenso'),      lineConfig('Censo por día', censo));
      new Chart(document.getElementById('chartEventos'),    lineConfig('Eventos de seguridad por día', eventos));
      new Chart(document.getElementById('chartDuplicidad'), lineConfig('Duplicidad por día', duplicidad));
      new Chart(document.getElementById('chartEncuesta'),   lineConfig('Encuesta por día', encuesta));
      new Chart(document.getElementById('chartTiempo'),     lineConfig('Tiempo promedio por día (min)', tavgMin));
    </script>
  {% endif %}
{% endblock %}
