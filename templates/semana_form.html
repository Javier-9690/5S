{% extends "base.html" %}
{% block content %}
  <h1>Ingresar nuevo registro</h1>
  <p class="muted">Selecciona una semana. Se mostrarán sus 7 días y podrás ingresar los valores por día.</p>

  <form method="get" action="{{ url_for('form_semana') }}">
    <div class="grid controls">
      <div>
        <label>Semana</label>
        <select name="semana" required>
          <option value="" disabled {{ 'selected' if not semana_sel }}>-- Elegir --</option>
          {% for num, rango in week_map.items()|sort %}
            <option value="{{ num }}" {{ 'selected' if semana_sel==num }}>
              {{ num }} ({{ rango[0] }} → {{ rango[1] }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" type="submit">Cargar días</button>
        <a class="btn" href="{{ url_for('listar') }}">Registros</a>
        <a class="btn" href="{{ url_for('dashboard') }}">Dashboard</a>
      </div>
    </div>
  </form>

  {% if semana_sel and dias %}
    <hr style="margin:16px 0;">
    <div class="muted">Semana {{ semana_sel }} • Desde <strong>{{ dias[0] }}</strong> hasta <strong>{{ dias[-1] }}</strong></div>

    <form method="post" action="{{ url_for('guardar') }}">
      <input type="hidden" name="semana" value="{{ semana_sel }}">

      <div style="overflow:auto; margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>Día</th>
              <th>Censo<br/><span class="muted">Cantidad</span></th>
              <th>Eventos de seguridad<br/><span class="muted">Cantidad</span></th>
              <th>Duplicidad<br/><span class="muted">Cantidad</span></th>
              <th>Encuesta de satisfacción<br/><span class="muted">Cantidad</span></th>
              <th>Tiempo de atención<br/><span class="muted">mm:ss</span></th>
            </tr>
          </thead>
          <tbody>
            {% for d in dias %}
              <tr>
                <td style="white-space:nowrap">{{ d }}</td>
                <td><input type="number" min="0" name="censo_{{ loop.index0 }}" placeholder="0"></td>
                <td><input type="number" min="0" name="eventos_{{ loop.index0 }}" placeholder="0"></td>
                <td><input type="number" min="0" name="duplicidad_{{ loop.index0 }}" placeholder="0"></td>
                <td><input type="number" min="0" name="encuesta_{{ loop.index0 }}" placeholder="0"></td>
                <td>
                  <input
                    type="text"
                    name="tiempo_{{ loop.index0 }}"
                    class="tiempo-mmss"
                    placeholder="mm:ss"
                    maxlength="5"
                    inputmode="numeric"
                    pattern="[0-9]{2}:[0-9]{2}"
                    title="Formato mm:ss, ej: 03:54"
                  >
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="toolbar">
        <button class="btn" type="submit">Guardar</button>
        <a class="btn" href="{{ url_for('listar') }}">Registros</a>
        <a class="btn" href="{{ url_for('dashboard') }}">Dashboard</a>
      </div>
    </form>

    <script>
      // Autoformateo + validación amigable mm:ss
      function normalizeToMMSS(v) {
        if (!v) return "";
        const parts = v.trim().split(":").map(p => p.trim());
        if (parts.length === 1) {
          const m = parts[0].replace(/\D/g, "");
          if (m === "") return "";
          return String(m).padStart(2, "0") + ":00";
        } else if (parts.length >= 2) {
          const m = parts[parts.length-2].replace(/\D/g, "");
          const s = parts[parts.length-1].replace(/\D/g, "");
          return String(m || "0").padStart(2, "0") + ":" + String(s || "0").padStart(2, "0");
        }
      }
      const reMMSS = /^[0-9]{2}:[0-9]{2}$/;
      function validateMMSS(inp){
        const val = inp.value.trim();
        if (val === "" || reMMSS.test(val)) inp.setCustomValidity("");
        else inp.setCustomValidity("Formato mm:ss, ej: 03:54");
      }
      document.querySelectorAll('input.tiempo-mmss').forEach(inp=>{
        inp.addEventListener('blur', ()=>{ inp.value = normalizeToMMSS(inp.value); validateMMSS(inp); });
        inp.addEventListener('input', ()=> validateMMSS(inp));
      });
      const form = document.querySelector('form[action="{{ url_for("guardar") }}"]');
      if (form) {
        form.addEventListener('submit', (e)=>{
          document.querySelectorAll('input.tiempo-mmss').forEach(inp=>{
            inp.value = normalizeToMMSS(inp.value); validateMMSS(inp);
          });
          const bad = Array.from(document.querySelectorAll('input.tiempo-mmss')).find(i=>!i.checkValidity());
          if (bad) { e.preventDefault(); bad.reportValidity(); }
        });
      }
    </script>
  {% endif %}
{% endblock %}
